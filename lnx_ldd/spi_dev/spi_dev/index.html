
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://www.vutang.github.io/lnx_ldd/spi_dev/spi_dev/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>SPI Device - Vu Tang's Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.08040f6c.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spi-device-driver" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Vu Tang&#39;s Docs" class="md-header__button md-logo" aria-label="Vu Tang's Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vu Tang's Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SPI Device
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Vu Tang&#39;s Docs" class="md-nav__button md-logo" aria-label="Vu Tang's Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Vu Tang's Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Preface
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          General Technote
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="General Technote" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          General Technote
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../technote/mkdocs/mkdocs-notes/" class="md-nav__link">
        Mkdocs Tool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../technote/markdown/markdown/" class="md-nav__link">
        Markdown Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../technote/shellscript/shellscript/" class="md-nav__link">
        Shell Script
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../technote/python/python/" class="md-nav__link">
        Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../technote/virtual_machine/virtual_box/" class="md-nav__link">
        Virtual Machine
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Book & Materials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Book & Materials" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Book & Materials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/c_books/" class="md-nav__link">
        C Programing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/linux/" class="md-nav__link">
        Linux Programing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/device_driver/" class="md-nav__link">
        Linux Device Driver
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/linux_kernel/" class="md-nav__link">
        Linux Kernel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/es_linux/" class="md-nav__link">
        Linux Embedded
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/dsa/dsa_toc/" class="md-nav__link">
        Data Structure & Algorithms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/others/" class="md-nav__link">
        Others
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Programming
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Programming" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Programming
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/C/cprogramming/" class="md-nav__link">
        C
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/dsa/dsa/" class="md-nav__link">
        DSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/sql/mysql/" class="md-nav__link">
        SQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/lnx/lpi/" class="md-nav__link">
        Linux Programming Interfaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/dsg_patterns/" class="md-nav__link">
        Design Patterns
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/multi-threaded-programming/" class="md-nav__link">
        Multi-threads
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/perf/perf/" class="md-nav__link">
        Perf
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Linux General
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux General" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Linux General
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx/linux/" class="md-nav__link">
        Unsorted
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx/cmds/" class="md-nav__link">
        Commands
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Linux ES Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux ES Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Linux ES Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/es/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/hw_platform/" class="md-nav__link">
        HW Platforms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/cmn_tool/" class="md-nav__link">
        Common Tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/version_control/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/ptlnx/" class="md-nav__link">
        Xilinx Petalinux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/yocto/" class="md-nav__link">
        Yocto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/eeprom/eeprom/" class="md-nav__link">
        EEPROM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/docker/docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/linuxptp/linuxptp/" class="md-nav__link">
        Linux PTP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/dpdk/dpdk/" class="md-nav__link">
        DPDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_es/tips/tips/" class="md-nav__link">
        Tips
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Linux Device Driver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux Device Driver" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Linux Device Driver
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel_module/" class="md-nav__link">
        Kernel Module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../platform_dev/platform_device/" class="md-nav__link">
        Platform Device
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          SPI Device
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        SPI Device
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spi-subsystem-in-linux" class="md-nav__link">
    SPI Subsystem in Linux
  </a>
  
    <nav class="md-nav" aria-label="SPI Subsystem in Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spi-device-driver-model" class="md-nav__link">
    SPI Device Driver Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spi-message-transfer" class="md-nav__link">
    SPI Message &amp; Transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-engineer" class="md-nav__link">
    For Engineer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-driver" class="md-nav__link">
    Protocol Driver
  </a>
  
    <nav class="md-nav" aria-label="Protocol Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probing" class="md-nav__link">
    Probing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cac-api-khac" class="md-nav__link">
    Các API khác
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spi-write-spi-read" class="md-nav__link">
    SPI-Write &amp; SPI-Read
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controller-driver" class="md-nav__link">
    Controller Driver
  </a>
  
    <nav class="md-nav" aria-label="Controller Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probing-controller" class="md-nav__link">
    Probing controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-spi_master" class="md-nav__link">
    Struct spi_master
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controller-driver-protocol-driver-spi-core" class="md-nav__link">
    Controller Driver, Protocol Driver &amp; SPI-Core
  </a>
  
    <nav class="md-nav" aria-label="Controller Driver, Protocol Driver &amp; SPI-Core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spi_writespi_read" class="md-nav__link">
    spi_write/spi_read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#master-transfer" class="md-nav__link">
    master-&gt;transfer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" class="md-nav__link">
    What's next?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refereneces" class="md-nav__link">
    Refereneces
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spi_advance/" class="md-nav__link">
        SPI Device Advance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gpio/gpio/" class="md-nav__link">
        GPIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../uart/uart/" class="md-nav__link">
        UART
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jesd/jesd/" class="md-nav__link">
        JESD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../audio/linux_audio/" class="md-nav__link">
        Audio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcie/pcie/" class="md-nav__link">
        PCIe
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Linux Kernel Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux Kernel Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Linux Kernel Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_kernel/kernel_data_structure/" class="md-nav__link">
        Kernel Data Structure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lnx_kernel/kernel_user_space/" class="md-nav__link">
        Kernel Space, User Space Interfaces
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          FPGA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="FPGA" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          FPGA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/timing_analysis/timing_analysis/" class="md-nav__link">
        Static Timing Analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/x_ipcore/xipcore/" class="md-nav__link">
        Xilinx IPCore
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Projects
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Projects" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Projects
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../projects/zynq/zynq/" class="md-nav__link">
        Zynq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../projects/imx8/imx8/" class="md-nav__link">
        IMX8
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../projects/pi3b/" class="md-nav__link">
        Raspberrypi 3B
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../bookmarks/bookmarks/" class="md-nav__link">
        Bookmarks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../whatnext/" class="md-nav__link">
        What's next
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../about/about/" class="md-nav__link">
        About me
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spi-subsystem-in-linux" class="md-nav__link">
    SPI Subsystem in Linux
  </a>
  
    <nav class="md-nav" aria-label="SPI Subsystem in Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spi-device-driver-model" class="md-nav__link">
    SPI Device Driver Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spi-message-transfer" class="md-nav__link">
    SPI Message &amp; Transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-engineer" class="md-nav__link">
    For Engineer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-driver" class="md-nav__link">
    Protocol Driver
  </a>
  
    <nav class="md-nav" aria-label="Protocol Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probing" class="md-nav__link">
    Probing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cac-api-khac" class="md-nav__link">
    Các API khác
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spi-write-spi-read" class="md-nav__link">
    SPI-Write &amp; SPI-Read
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controller-driver" class="md-nav__link">
    Controller Driver
  </a>
  
    <nav class="md-nav" aria-label="Controller Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probing-controller" class="md-nav__link">
    Probing controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-spi_master" class="md-nav__link">
    Struct spi_master
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controller-driver-protocol-driver-spi-core" class="md-nav__link">
    Controller Driver, Protocol Driver &amp; SPI-Core
  </a>
  
    <nav class="md-nav" aria-label="Controller Driver, Protocol Driver &amp; SPI-Core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spi_writespi_read" class="md-nav__link">
    spi_write/spi_read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#master-transfer" class="md-nav__link">
    master-&gt;transfer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" class="md-nav__link">
    What's next?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refereneces" class="md-nav__link">
    Refereneces
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="spi-device-driver"><strong><span style="color:red">SPI Device Driver</span></strong></h1>
<p><img alt="spi_bus_signals" src="../img/spi-bus-signals-2.jpg" /></p>
<p><em>Hanoi - Tuesday, January 29, 2019 - by <a href="../../../about/about/">VuTang</a></em></p>
<h2 id="introduction">Introduction</h2>
<p>SPI là chuẩn giao tiếp nối tiếp dựa trên mô hình Master-Slaves, trong đó một master có thể được
kết nối đến một hoặc nhiều thiết bị slave. Một bus SPI thông thường có 4 tín hiệu:</p>
<ul>
<li>SCLK: clock dùng cho đồng bộ tín hiệu</li>
<li>SS: Slave Select, dùng để đánh dấu thiết bị Slave nào được active để trao đổi dữ liệu. Pin này
có thể được gọi bằng các tên khác như: CS (chip sellect), LE (Latch Enable), … Tín hiệu SS thông thường active mức thấp.</li>
<li>MISO: dữ liệu vào của master</li>
<li>MOSI: dữ liệu ra của master. Trong một số trường hợp, pin MISO/MOSI có thể được sử dụng chung trên một đường tín hiệu đảm nhiệm cả hai chức năng in/out.</li>
</ul>
<p><img alt="spi_bus_signals" src="../img/spi-bus-signals.png" /><br />
<em><span style="color:blue">Figure. SPI bus signals</span></em></p>
<h2 id="spi-subsystem-in-linux">SPI Subsystem in Linux</h2>
<p>Các kiến thức trong technote này được khái quát hóa sau quá trình tìm hiểu hệ thống SPI sử dụng Cadence Controller và SPI-GPIO, do đó có thể không mang được tính tổng quát hóa lên toàn bộ các thiết bị SPI.</p>
<ul>
<li><a href="xxx">spi.h</a>: defines important data structures what are used for SPI subsystem.</li>
<li><a href="xxx">spi.c</a>: SPI core APIs are implemented in this file.</li>
</ul>
<h3 id="spi-device-driver-model">SPI Device Driver Model</h3>
<p>Trong Figure 1 thể hiện mô hình của một hệ thống SPI trong Linux, bao gồm:</p>
<ul>
<li>Về phần cứng, một SPI device (slave device) được kết nối với SPI controller thông qua một bus vật lý (các tín hiệu của SPI bus mô tả ở phần trước được thiết kế trên mạch cứng). Một SPI device được đặc mô tả bởi <code>struct spi_device</code>.</li>
<li>Về phần mềm, hai thực thể phần cứng trên cần driver để giao tiếp và quản lý, driver cho controller (<strong><span style="color:red">controller driver</span></strong>) và driver cho spi device (<strong><span style="color:red">protocol driver</span></strong> - this deffinition is used in Linux Kernel official document). Linux Kernel provides a sub-system to manage these device drivers, called SPI-core. All controller driver &amp; protocol driver have to register to Spi-core. Cấu trúc dữ liệu đặc quan trọng nhất cho một controller là <code>struct spi_master</code></li>
</ul>
<p><a name="figure1"></a></p>
<p><img alt="spi_platform" src="../img/spi-platform.png" /></p>
<p><em><span style="color:blue">Figure 1. Components in SPI Subsystem</span></em></p>
<h3 id="spi-message-transfer">SPI Message &amp; Transfer</h3>
<p>Thông tin trao đổi giữa controller và device được khái quát hóa trong Linux SPI subsystem thành dạng các message. Các message này được chia nhỏ thành các transfer. Linux cung cấp <code>struct spi_message</code> và <code>struct spi_transfer</code> để mô tả các đối tượng này. Các struct này đều được định nghĩa trong spi.h.</p>
<p><img alt="spi_msg_wth_xfer" src="../img/spi-msg-xfer.PNG" /></p>
<p><em><span style="color:blue">Figure. SPI msg has a list of SPI transfer</span></em></p>
<p>spi_message chứa một danh sách các transfer:</p>
<pre><code>struct spi_message {
    struct list_head    transfers;
    ...
}
</code></pre>
<p>Quá trình duyệt toàn bộ transfers trong list có thể thực hiện như sau:</p>
<pre><code>list_for_each_entry(xfer, &amp;msg-&gt;transfers, transfer_list) {
    ...
}
</code></pre>
<p>this function is used in <code>spi_transfer_one_message()</code> - a default implementation of <code>transfer_one_message()</code> in spi.c.</p>
<p>See in <a href="../../../lnx_kernel/kernel_data_structure/#linked-list">Kernel Data Structure</a> for more information about  Linked List in device driver development.</p>
<h3 id="for-engineer">For Engineer</h3>
<p>So, what is mission for engineer in a SPI system?</p>
<ul>
<li>
<p>Phát triển protocol driver: các ứng dụng trên tầng ứng dụng cần truy cập đến thông tin trên các SPI Device (ví dụ như đọc giá trị nhiệt độ từ một cảm biến, cấu hình tín hiệu clock cho một hệ thống...). Do đó nhiệm vụ đầu tiên của một kỹ sư là phát triển Protocol Driver để cung cấp các API giao tiếp để ứng dụng có thể truy cập đến phần cứng chứa giao diện SPI.</p>
</li>
<li>
<p>Phát triển controller driver: thông thường driver của controller thường được các nhà phát triển tích hợp kèm với controller. Nhiệm vụ của kỹ sư trong một số trường hợp là tiến hành thay đổi controller driver này cho phù hợp với hệ thống hiện tại. Ngoài ra, kỹ sư có thể phát triển thêm các controller driver để phù hợp với yêu cầu của hệ thống.</p>
</li>
<li>
<p>Bổ sung thêm một số chức năng cho SPI-Core: giao diện SPI với các tín hiệu như mục giới thiệu là giao diện chuẩn, trong khi các biến tấu của giao diện SPI trong thực tế là rất nhiều. Những biến tấu này yêu cầu kỹ sư phải hiểu sâu về SPI-Core để trong một số trường hợp có thể bổ sung thêm một số API. Về tư tưởng phát triển, quá trình viết một driver phải độc lập với Linux kernel, do đó hoạt động thay đổi và bổ sung vào SPI-Core này nên hạn chế vì rõ ràng can thiệp vào SPI-Core tức là ít nhiều can thiệp vào Linux Kernel.</p>
</li>
</ul>
<h2 id="protocol-driver">Protocol Driver</h2>
<p>Các phần khác của hệ thống (ví dụ như các ứng dụng trên user space, các kernel module khác) sử dụng các API của Protocol Driver để có thể giao tiếp được với SPI Device.</p>
<p>Tượng tự như controller driver và platform device driver, spi protocol driver cũng cần chứa các thủ tục cơ bản của một device driver.</p>
<ul>
<li>Khai báo spi driver <code>struct spi_driver</code> và đăng ký với kernel bằng macro <code>module_spi_driver()</code>. Struct driver này chứa các con trỏ chỉ đến các hàm khởi tao (probe) và hàm hủy (remove) của driver, các hàm này sau khi được đăng ký sẽ được gọi bởi Kernel.</li>
<li>Khai báo id_table <code>struct spi_device_id</code> chứa thông tin của các device mà driver này hỗ trợ.</li>
</ul>
<h3 id="probing">Probing</h3>
<p>Hàm probing của Protocol Driver có thể thực hiện chức năng như:</p>
<ul>
<li>Lấy thông tin của struct spi_device *spi lưu trữ nội bộ của module để sử dụng cho các API khác.</li>
<li>Thực hiện cấu hình ban đầu cho spi device.</li>
</ul>
<h3 id="cac-api-khac">Các API khác</h3>
<p>Giống như các Device Driver khác, protocol driver có chứa các API cung cấp các cổng giao tiếp với User Space thông quan Device File (/dev/), procfs, sysfs. Thông qua các system call như IOCTL, read, write..., các ứng dụng user space có thể truy cập đến thiết bị.</p>
<p>Vấn đề đặt ra là làm thế nào để Protocol Driver có thể giao tiếp được đến Spi device?</p>
<h3 id="spi-write-spi-read">SPI-Write &amp; SPI-Read</h3>
<p>Protocol uses APIs from SPI-core to communicate with SPI device. These APIs are:</p>
<ul>
<li><code>int spi_write(struct spi_device *spi, const void *buf, size_t len)</code><br />
Take buffer (with length) as a pointer and then initialize a spi message. This message will be sent to slave device through spi controller (this procedure will be discussed detail in next part).<br />
In example below, <code>spi_write</code> is used in a function for writing a value to a register (specified by address) in device. An message with header (0x80), register address (addr) and expected value (val) will be sent to device.  </li>
</ul>
<pre><code>int xxx_write(struct spi_device *spi, unsigned addr, unsigned val) {
    unsigned char  txbuf[3];
    int rc;

    txbuf[0] = 0x00;
    txbuf[1] = addr &amp; 0xFF;
    txbuf[2] = val;

    rc = spi_write(spi, txbuf, 3);
    return rc;
}
</code></pre>
<ul>
<li><code>int spi_write_then_read(struct spi_device *spi, const void *txbuf, unsigned n_tx, void *rxbuf, unsigned n_rx)</code></li>
</ul>
<p>API này thường được sử dụng để đọc thanh ghi của một thiết bị. Một bản tin từ controller được gửi cho device về yêu cầu đọc thanh ghi, device phản hồi thông tin cho controller và trả lại kết quả cho protocl driver.</p>
<p>Trong ví dụ sau, user buffer có kích thước 3 bytes được sử dụng như tx_buf và rx_buf (2 bytes đầu tiên được sử dụng cho tx, 1 byte tiếp theo sử dụng cho rx). Message buf[0:1] được gửi đi đến device, kết quả trả lại của device được lưu trữ trong buf[2].</p>
<pre><code>int xxx_read(struct spi_device *spi, unsigned addr) {
    unsigned char buf[3];
    int rc;

    buf[0] = 0x80;
    buf[1] = addr &amp; 0xFF;
    buf[2] = 0x00;

    rc = spi_write_then_read(spi, buf, 2, &amp;buf[2],1);
    return (rc &lt; 0 ? rc : buf[2]);
}
</code></pre>
<p>Bản chất hoạt động của các API trên sẽ được mô tả ở trong phần cuối của tài liệu này.</p>
<h2 id="controller-driver">Controller Driver</h2>
<p>Là kernel module giao tiếp trực tiếp với SPI Controller. SPI controller này có thể là Hard-controller (như controller của Cadence được tích hợp sẵn trong ngoại vi của SoC) hoặc cũng có thể là Soft-controller như SPI-GPIO (Bitbanging).</p>
<h3 id="probing-controller">Probing controller</h3>
<p><strong><em>Initialize a spi master</em></strong></p>
<p>Một controller sẽ được đặc trưng bởi kiểu dữ liệu: <code>struct spi_master</code> (được định nghĩa trong: linux/include/spi/spi.h). Quá trình khai báo controller được thực hiện trong hàm probe.</p>
<pre><code>struct spi_master *master;

/*Allocate spi master*/
master = spi_alloc_master(&amp;spi-&gt;dev, sizeof(*spi_ad9250));
if (!master)
    return -ENOMEM;
</code></pre>
<p><strong><em>Set spi master to spi private private data</em></strong></p>
<p>Thông thường, con trỏ chứa địa chỉ của spi_master sẽ được lưu trữ trong các private data của device để thuận tiện cho quá trình sử dụng sau này. Cụ thể các API được sử dụng để lưu trữ master vào <em>drvdata</em> như sau:</p>
<ul>
<li>Nếu controller là một <em>platform device pdev</em>: <code>platform_set_drvdata(pdev, master);</code></li>
<li>Nếu controller là một <em>spi device spi</em>: <code>spi_set_drvdata(spi, master)</code></li>
</ul>
<p><strong><em>Register spi master</em></strong></p>
<pre><code>ret = spi_register_master(master);
if (ret) {
    dev_err(&amp;pdev-&gt;dev, &quot;spi_register_master failed\n&quot;);
    return -1;
}
</code></pre>
<p><strong><em>Unregister spi master</em></strong></p>
<p>Ví dụ đối với trường hợp controller là spi device:</p>
<pre><code>struct spi_master *master = spi_get_drvdata(spi);

spi_unregister_master(master);
</code></pre>
<p><strong><em>Declare devices in Device Tree</em></strong></p>
<p>Quá trình khai báo một thiết bị trong device tree cần lưu ý đến:</p>
<ul>
<li>thuộc tính num-cs củm father-node</li>
<li>Thuộc tính spi-max-frequency của node (why???)</li>
</ul>
<pre><code>spi@e0006000 {
    compatible = &quot;xlnx,zynq-spi-r1p6&quot;;
    reg = &lt;0xe0006000 0x1000&gt;;
    status = &quot;okay&quot;;
    interrupt-parent = &lt;0x1&gt;;
    interrupts = &lt;0x0 0x1a 0x4&gt;;
    clocks = &lt;0x2 0x19 0x2 0x22&gt;;
    clock-names = &quot;ref_clk&quot;, &quot;pclk&quot;;
    #address-cells = &lt;0x1&gt;;
    #size-cells = &lt;0x0&gt;;

    spi-fmcjesdadc1@0 {
        #address-cells = &lt;0x1&gt;;
        #size-cells = &lt;0x0&gt;;
        compatible = &quot;spi-ad9250&quot;;
        reg = &lt;0x0&gt;;
        spi-max-frequency = &lt;0x989680&gt;;

        ad9517@1 {
            #clock-cells = &lt;0x1&gt;;
            compatible = &quot;ad9517-1&quot;;
            reg = &lt;0x1&gt;;
            spi-max-frequency = &lt;0x989680&gt;;
            adi,spi-3wire-enable;
            clocks = &lt;0x4 0x5&gt;;
            clock-names = &quot;refclk&quot;, &quot;clkin&quot;;
            clock-output-names = &quot;out0&quot;, &quot;out1&quot;, &quot;out2&quot;, &quot;out3&quot;, &quot;out4&quot;, &quot;out5&quot;, &quot;out6&quot;, &quot;out7&quot;;
            linux,phandle = &lt;0x15&gt;;
            phandle = &lt;0x15&gt;;
        };

        ad9250-0@0 {
            compatible = &quot;ad9250&quot;;
            reg = &lt;0x2&gt;;
            spi-max-frequency = &lt;0x989680&gt;;
            clocks = &lt;0x6&gt;;
            clock-names = &quot;adc_clk&quot;;
            linux,phandle = &lt;0x11&gt;;
            phandle = &lt;0x11&gt;;
        };
</code></pre>
<h3 id="struct-spi_master">Struct spi_master</h3>
<p>Với tất cả các spi controller, spi controller driver cần có các hàm thủ tục để có thể giao tiếp được với các controller tương ứng. Các hàm và thủ tục này được chuẩn hóa và khái quát hóa thành một cấu trúc dữ liệu: struct spi_master.</p>
<p>Struct spi_master được định nghĩa trong <a href="https://elixir.bootlin.com/linux/v4.8/source/include/linux/spi/spi.h#L400">spi.h</a>.</p>
<p><strong><em>About struct spi_master</em></strong></p>
<ul>
<li><strong>transfer_one_message</strong>: transfer a single message. SPI GPIO (bitbanging) uses this method.</li>
<li><strong>transfer_one</strong>: transfer a single spi_transfer. SPI Cadence controller uses this method.</li>
</ul>
<p><strong><em>Register devices from device</em></strong></p>
<p>Đăng ký các thiết bị thuộc bus SPI mà spi master đang quản lý bằng API:</p>
<p><code>static void of_register_spi_devices(struct spi_master *master);</code></p>
<p>API này sẽ duyệt hết tất cả các child-node xuất hiện trên Device Tree và tiến hành thêm thiết bị đó vào hệ thống bằng API: <code>spi_add_device</code></p>
<h2 id="controller-driver-protocol-driver-spi-core">Controller Driver, Protocol Driver &amp; SPI-Core</h2>
<p>Mục này mô tả quá trình Protocol Driver thông qua các API để sử dụng các tài nguyên của Controller Driver.</p>
<h3 id="spi_writespi_read"><span style="color:blue">spi_write/spi_read</span></h3>
<p>Các protocol driver gọi đến các API như <code>spi_write/spi_read/spi_write_then_read</code>, bản chất trong các API này sẽ thực hiện các bước sau:</p>
<ul>
<li>Khai báo và cấp phát <code>struct spi_transfer</code> và <code>struct spi_message</code>  </li>
</ul>
<pre><code>struct spi_transfer t = {
    .tx_buf     = buf,
    .len        = len,
};

struct spi_message  m;
spi_message_init(&amp;m);
spi_message_add_tail(&amp;t, &amp;m);
</code></pre>
<ul>
<li>Gọi đến <code>spi_sync</code> - blocking/synchronous SPI data transfers. <code>spi_sync</code> sẽ gọi đến con trỏ hàm <code>master-&gt;transfer</code>, một phương thức cung cấp bởi <code>spi_master</code>.<br />
<code>master-&gt;transfer(spi, message);</code></li>
</ul>
<h3 id="master-transfer"><span style="color:blue">master-&gt;transfer</span></h3>
<p>Đa phần trong các trường hợp, controller trong một lúc sẽ nhận được rất nhiều yêu cầu trao đổi thông tin với các device. Do đó, để tránh quá trình xung đột trong chia sẻ tài nguyên liên quan đến controller, SPI-core sử dụng mô hình hàng đợi cho các yêu cầu.</p>
<p><strong><code>master-&gt;transfer</code> làm việc như thế nào trong SPI subsytem?</strong></p>
<ul>
<li>
<p>Trong quá trình đăng ký <code>spi_master</code> cho controller driver, API <code>spi_register_master</code> khởi tạo một hàng đợi cho <code>spi_master</code> bằng API <code>spi_master_initialize_queue</code> (hàm này sẽ gọi đến <code>spi_init_queue</code>).</p>
</li>
<li>
<p><code>spi_init_queue</code> này sẽ thực hiện khởi tạo một kernel thread bằng <code>kthread_run</code>. SPI-core sử dụng khái niệm <code>kworker</code> và <code>kwork</code> để xử lý các <code>master-&gt;transfer</code>.</p>
</li>
</ul>
<p><strong><code>master-&gt;transfer</code> và <code>kworker/kwork</code></strong></p>
<p>Về tư tưởng <code>kworker/kwork</code> trong Linux Kernel, một <code>kworker</code> được cấp phát tài nguyên (CPU) sẽ được sử dụng đề hoàn thành các <code>kwork</code>.</p>
<p>Trong SPI-subsystem cũng hoạt động với cơ chế tương tự, mỗi master được khởi tạo một <code>struct kthread_worker kworker</code> bằng API <code>init_kthread_worker</code> trong <code>spi_init_queue</code>. <code>spi_init_queue</code> đồng thời khởi tạo một kernel thread dành riêng để thực hiện <code>kthread_worker</code> này.</p>
<p>Đối với Cadence Controller, hàm <code>master-&gt;transfer</code> được định nghĩa bằng <code>spi_queued_transfer</code> trong SPI core. Quá trình thực hiện của <code>spi_queued_transfer</code> bản chất là đưa <code>spi_message</code> vào work queue để chờ <code>kwork</code> xử lý.</p>
<p>Như vậy, các request message từ protocol driver được xếp thành hàng để kworker/kwork xử lý. Bản chất <code>kwork-&gt;fn</code> trỏ đến <code>spi_pump_messages</code>.</p>
<p><strong><code>spi_pump_messages</code></strong></p>
<p>Thực hiện "bơm" bản tin vào SPI bus bằng các gọi đến <code>master-&gt;transfer_one_message</code></p>
<p><strong><code>master-&gt;transfer_one_message</code></strong></p>
<p><code>transfer_one_message</code> có thể được định nghĩa trong controller driver. Trong trường hợp không được định nghĩa trong quá trình khai báo <code>spi_master</code> của controller driver, <code>transfer_one_message</code> được trỏ đến hàm <code>spi_transfer_one_massge</code> định nghĩa trong SPI core.</p>
<h2 id="whats-next">What's next?</h2>
<ul>
<li>
<p>spi_master có thể cần cung cấp hàm cho các phương thức như: <code>transfer_one_message</code>, <code>transfer_one</code>. Vậy khác nhau giữa hai phương thức này là gì?</p>
</li>
<li>
<p>Mô tả các trường hợp thiết kế SPI bus trong thực tế.</p>
</li>
</ul>
<h2 id="refereneces">Refereneces</h2>
<ul>
<li><a href="http://events17.linuxfoundation.org/sites/events/files/slides/Groking%20the%20Linux%20SPI%20Subsystem.pdf">Groking the Linux SPI Subsystem</a> - Embedded Linux Conference 2017</li>
<li>spi/spi-summary - Linux Kernel Document (<a href="https://elixir.bootlin.com/linux/latest/source/Documentation/spi/spi-summary">link</a>)</li>
<li>The Linux Kernel - <a href="https://www.kernel.org/doc/html/v4.15/driver-api/spi.html">SPI</a></li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../platform_dev/platform_device/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Platform Device" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Platform Device
            </div>
          </div>
        </a>
      
      
        
        <a href="../spi_advance/" class="md-footer__link md-footer__link--next" aria-label="Next: SPI Device Advance" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              SPI Device Advance
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2018 Vu Tang.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
    
  </body>
</html>